<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Swagger Editor (EditorLayout)</title>
  <link rel="stylesheet" href="https://unpkg.com/swagger-editor-dist/swagger-editor.css">
  <style>
    /* å…¨ç”»é¢è¡¨ç¤ºã®ãŸã‚ã®åŸºæœ¬è¨­å®š */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* ç”»é¢å…¨ä½“ã«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ */
    }
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    #main-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    /* Swagger Editorã®ã‚³ãƒ³ãƒ†ãƒŠ */
    #swagger-editor {
      flex: 1;
      display: flex;
      min-height: 0;  /* Flex item ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾ç­– */
      overflow: hidden;
    }
    /* å†…éƒ¨ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦ã‚‚ min-height: 0 ã‚’æŒ‡å®š */
    .swagger-container {
      display: flex;
      flex: 1 1 0;
      min-height: 0;
    }
    /* å·¦å³ãƒšã‚¤ãƒ³å…±é€š */
    .Pane {
      flex: 1 1 0;
      overflow: auto;
      min-height: 0;
    }
    /* CodeMirror ã®é«˜ã•ã‚’100%ã«ã—ã€max-heightã‚’è§£é™¤ */
    .CodeMirror,
    .CodeMirror-scroll {
      height: 100% !important;
      max-height: none !important;
      overflow-y: auto !important;
    }
    /* å¿…è¦ã«å¿œã˜ã¦å³å´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼(.swagger-ui)ã«ã‚‚èª¿æ•´ã‚’åŠ ãˆã‚‹ */
    .swagger-ui,
    .swagger-ui .wrapper {
      max-height: none;
      overflow-y: auto;
    }
    /* ãƒœã‚¿ãƒ³ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½ç½® */
    .button-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    #message {
      margin: 10px;
      color: red;
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="swagger-editor" class="swagger-container"></div>
    <div class="button-container">
      <button id="submit-api">ğŸ’¾ APIã¨ã—ã¦ä¿å­˜</button>
    </div>
    <p id="message"></p>
  </div>

  <!-- Swagger Editor ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="https://unpkg.com/swagger-editor-dist/swagger-editor-bundle.js"></script>
  <script src="https://unpkg.com/swagger-editor-dist/swagger-editor-standalone-preset.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // layout: "EditorLayout" ã‚’æŒ‡å®šã™ã‚‹ã®ãŒé‡è¦
      const editor = SwaggerEditorBundle({
        dom_id: '#swagger-editor',
        layout: "EditorLayout",
        presets: [SwaggerEditorStandalonePreset],
        // ä»»æ„ã§æ—¢å®šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŒ‡å®šã™ã‚‹å ´åˆ
        swaggerDoc: {
          openapi: "3.0.0",
          info: {
            title: "æ–°è¦APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ",
            version: "1.0.0",
            description: "Swagger Editor (EditorLayout) ã®ã‚µãƒ³ãƒ—ãƒ«"
          },
          paths: {}
        }
      });

      // ãƒªã‚µã‚¤ã‚ºæ™‚ã« CodeMirror ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ãŸã„å ´åˆ (å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“)
      window.addEventListener('resize', () => {
        // ç›´æ¥ DOM ã‹ã‚‰ CodeMirror ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã— refresh
        setTimeout(() => {
          const cmInstance = document.querySelector('.CodeMirror')?.CodeMirror;
          cmInstance?.refresh();
        }, 100);
      });

      // ä¾‹: APIä¿å­˜ãƒœã‚¿ãƒ³ã®å‡¦ç†
      document.getElementById('submit-api').addEventListener('click', async () => {
        const messageElement = document.getElementById('message');
        messageElement.textContent = ""; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆæœŸåŒ–

        try {
          // Swagger Editor ã®ç¾åœ¨ã®JSONã‚’å–å¾—
          const specJson = editor.specSelectors.specJson().toJS();
          const title = specJson.info?.title || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«';
          const description = specJson.info?.description || 'èª¬æ˜ãªã—';
          const content = JSON.stringify(specJson, null, 2);

          // ä»»æ„ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ä¿å­˜ (ä¾‹)
          const response = await fetch('http://localhost/api/openapi-specs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: title,
              description: description,
              content: content
            })
          });
          if (response.ok) {
            messageElement.textContent = 'âœ… ä½œæˆã«æˆåŠŸã—ã¾ã—ãŸï¼';
            // ä¾‹: 1.5ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            setTimeout(() => window.location.href = '/index.html', 1500);
          } else {
            const error = await response.json();
            messageElement.textContent = `âš  ã‚¨ãƒ©ãƒ¼: ${JSON.stringify(error)}`;
          }
        } catch (error) {
          messageElement.textContent = `âš  é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        }
      });
    });
  </script>
</body>
</html>